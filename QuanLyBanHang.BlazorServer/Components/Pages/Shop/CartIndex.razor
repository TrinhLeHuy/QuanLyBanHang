@inject IJSRuntime JS

<div class="modal-content">
    
    <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
            <i class="bi bi-cart-check me-2"></i> Giỏ Hàng Của Bạn
        </h5>
        <button type="button" class="btn-close btn-close-white" @onclick="() => OnClose.InvokeAsync(false)" aria-label="Close"></button>
    </div>

    <div class="modal-body p-3">
        
        <div class="row text-muted fw-bold border-bottom pb-2 mb-2 d-none d-md-flex">
            <div class="col-1">Chọn</div>
            <div class="col-5">Sản Phẩm</div>
            <div class="col-2 text-center">Đơn Giá</div>
            <div class="col-2 text-center">Số Lượng</div>
            <div class="col-2 text-center">Thao Tác</div>
        </div>

        @if (CartItems.Any())
        {
            @foreach (var item in CartItems)
            {
                <div class="cart-item-row row align-items-center py-2 border-bottom">
                    
                    <div class="col-1 text-center">
                        <input class="form-check-input" type="checkbox" @onchange="(e) => Onchanged(e,item.Id)" disabled="@(item.Status == CartItemStatus.OutStock)"/>
                    </div>

                    <div class="col-5 d-flex align-items-center">
                        <img src="" class="me-3 rounded" style="width: 60px; height: 60px; object-fit: cover;" alt="@item.Product.Name" />
                        <div>
                            <span class="d-block fw-bold product-name-cart">@item.Product.Name</span>
                            @if (item.Status == CartItemStatus.InStock)
                            {
                                <small class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Còn hàng</small>
                            }
                            else
                            {
                                <small class="text-danger fw-bold"><i class="bi bi-x-circle-fill"></i> Hết hàng</small>
                            }
                        </div>
                    </div>

                    <div class="col-2 text-center fw-bold">
                        @(item.Product.Price.ToString("N0"))₫
                    </div>

                    <div class="col-2 text-center">
                        <input type="number" class="form-control form-control-sm text-center" 
                               @bind="item.Quantity" 
                               min="1" max="@(item.Status == CartItemStatus.InStock ? 100 : 0)" 
                               style="max-width: 80px; margin: 0 auto;"
                               />
                    </div>

                    <div class="col-2 text-center">
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => OnRemoveItem.InvokeAsync(item.Id)">
                            <i class="bi bi-trash"></i> Xóa
                        </button>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted my-5">Giỏ hàng của bạn đang trống.</p>
        }

    </div>

    <div class="modal-footer d-block">
        
        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded border">
    
        <div class="d-flex align-items-center">
            <label class="fw-bold text-danger me-3 mb-0">
                <i class="bi bi-tag-fill me-1"></i> Voucher/Mã giảm giá:
            </label>
        
            @if (!string.IsNullOrEmpty(AppliedVoucherCode))
            {
                <span class="badge bg-success fw-bold me-2">
                    @AppliedVoucherCode
                </span>
                <small class="text-success">
                    (@AppliedVoucherDisplay)
                </small>
            }
            else
            {
                <span class="text-muted small">Chưa áp dụng</span>
            }
        </div>
    
        <button class="btn btn-sm btn-outline-danger" 
                @onclick="OnOpenVoucher">
            <i class="bi bi-ticket-detailed me-1"></i> 
            @(string.IsNullOrEmpty(AppliedVoucherCode) ? "Chọn Voucher" : "Đổi/Hủy")
        </button>
    </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <label class="fs-5 text-muted">Tổng cộng:</label>
            <label class="fs-4 fw-bold text-danger" id="totalPrice">
                @(TotalPrice.ToString("N0"))₫ 
                <span class="fs-6 text-muted">(Đã bao gồm VAT)</span>
            </label>
        </div>

        <div class="d-grid">
            <button type="button" class="btn btn-danger btn-lg" 
                    @onclick="OnCheckoutClicked"
                    disabled="@(!CartItems.Any(i => i.Status == CartItemStatus.InStock))">
                <i class="bi bi-cart-fill me-2"></i> Thanh Toán (@SelectedItemsCount Sản phẩm)
            </button>
        </div>
    </div>
</div>
<DialogContainer IsOpen="@showDialog" IsOpenChanged="OnDialogChanged">
    @currentDialog
</DialogContainer>

@code {
    [Parameter] public List<CartItems> CartItems { get; set; } = new();
    [Parameter] public EventCallback<bool> OnClose { get; set; }
    [Parameter] public EventCallback<int> OnRemoveItem { get; set; }
    [Parameter] public EventCallback<CheckoutEventAgrs> OnCheckout { get; set; }
    [Parameter] public List<Voucher> Vouchers { get; set; } = new();
    bool showDialog = false;
    RenderFragment? currentDialog;
    public string AppliedVoucherCode { get; set; } = string.Empty; 
    public string AppliedVoucherDisplay { get; set; } = string.Empty;
    public Voucher? voucherApplied { get; set; } = null;
    public List<int> SelectedItemIds { get; set; } = new List<int>();
    public decimal TotalPrice 
    {
        get
        {
            if (voucherApplied == null)
            {
                return CartItems
                .Where(i => i.Status == CartItemStatus.InStock && SelectedItemIds.Contains(i.Id))
                .Sum(i => i.Product.Price * i.Quantity);
            }
            else
            {
                if(voucherApplied.DiscountType == DiscountType.Percent)
                {
                    return CartItems
                    .Where(i => i.Status == CartItemStatus.InStock && SelectedItemIds.Contains(i.Id))
                    .Sum(i => i.Product.Price * i.Quantity)*(1-voucherApplied.DiscountValue);
                }
                else
                {
                    return CartItems
                    .Where(i => i.Status == CartItemStatus.InStock && SelectedItemIds.Contains(i.Id))
                    .Sum(i => i.Product.Price * i.Quantity) - voucherApplied.DiscountValue;
                }
            }

        } 
    }
    public int SelectedItemsCount => CartItems.Count(i => SelectedItemIds.Contains(i.Id));

    protected override void OnParametersSet()
    {

    }

    private async Task OnCheckoutClicked()
    {
        if (SelectedItemIds.Any())
        {
            if(await ShowConfirm("Bạn xác nhận thanh toán đơn hàng này chứ?"))
            {
                await OnCheckout.InvokeAsync(new CheckoutEventAgrs()
                {
                    SelectedCartItemIds=SelectedItemIds,
                    VoucherId=voucherApplied?.Id
                });
                await OnClose.InvokeAsync(false);
            }
        }
        else
        {
            await ShowError("Vui lòng chọn ít nhất 1 sản phẩm để thành toán!");
        }
    }
    void Onchanged(ChangeEventArgs eventArgs, int cartItemId)
    {
        bool isChecked = eventArgs.Value as bool? ?? false;
        if (isChecked)
        {
            SelectedItemIds.Add(cartItemId);
        }
        else
        {
            SelectedItemIds.Remove(cartItemId);
        }
    }
    Task OnDialogChanged(bool v)
    {
        showDialog = v;
        return Task.CompletedTask;
    }

    void OnOpenVoucher()
    {
        currentDialog = builder =>
        {
            builder.OpenComponent(0, typeof(CartVoucher));
            builder.AddAttribute(1, "AvailableVouchers", Vouchers);
            builder.AddAttribute(2, "OnVoucherApplied", EventCallback.Factory.Create<int>(this, AppliedVoucher));
            builder.AddAttribute(2, "OnCloseDialog", EventCallback.Factory.Create<bool>(this, OnCloseDialog));
            builder.CloseComponent();
        };

        showDialog = true;
        StateHasChanged();
    }

    void AppliedVoucher(int voucherId)
    {
        var target = Vouchers.FirstOrDefault(v => v.Id == voucherId);
        if (target != null)
        {
            AppliedVoucherCode = target.Code;
            if (target.DiscountType == DiscountType.Fixed)
            {
                AppliedVoucherDisplay = $"Giảm {target.DiscountValue.ToString("N0")}₫";
            }
            else
            {
                AppliedVoucherDisplay = $"Giảm {(target.DiscountValue*100).ToString("N0")}%";
            }
        }
        else
        {
            AppliedVoucherCode = string.Empty;
            AppliedVoucherDisplay = string.Empty;
        }
        voucherApplied = target;
    }
    void OnCloseDialog(bool v)
    {
        showDialog = v;
        StateHasChanged();
    }

    private async Task ShowSuccess(string message)
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowSuccess", message);
    }

    private async Task ShowError(string message)
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowError", message);
    }

    private async Task<bool> ShowConfirm(string message)
    {
        bool confirmed = await JS.InvokeAsync<bool>("SwalInterop.ShowConfirm", message);
        return confirmed;
    }
}
