<div class="card bill-summary shadow-sm border">
    <div class="card-header bg-danger text-white fw-bold fs-5">
        <i class="bi bi-file-text me-2"></i> Thông tin thanh toán
    </div>
    <div class="card-body p-3">

        <h6 class="fw-bold mb-3 text-muted">Chi tiết đơn hàng</h6>
        
        <ul class="list-group list-group-flush mb-3">

            <li class="list-group-item px-0 py-1 bg-light fw-bold">
                <div class="row">
                    <div class="col-6">Mặt hàng</div>
                    <div class="col-3 text-center">SL</div>
                    <div class="col-3 text-end">Thành tiền</div>
                </div>
            </li>
            
            @if (NewOrder.OrderDetails.Any())
            {
                @foreach (var item in NewOrder.OrderDetails)
                {
                    <li class="list-group-item px-0 py-1">
                        <div class="row small">
                            <div class="col-6 text-truncate">@item.Product.Name</div>
                            <div class="col-3 text-center text-muted">@item.Quantity</div>
                            <div class="col-3 text-end fw-medium">@item.SubTotal.ToString("N0")₫</div>
                        </div>
                    </li>
                }
            }
            else
            {
                 <li class="list-group-item px-0 py-1 text-center text-muted">Không có sản phẩm nào được chọn.</li>
            }
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                <span class="text-secondary">Tổng tiền hàng (@NewOrder.OrderDetails.Count sản phẩm)</span>
                <span class="fw-medium">@TotalProductPrice.ToString("N0")₫</span>
            </li>
            
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                <span class="text-secondary">Phí vận chuyển</span>
                <span class="fw-medium text-info">@ShippingFee.ToString("N0")₫</span>
            </li>
            
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1 border-bottom">
                <span class="text-secondary">Thuế (VAT 10%)</span>
                <span class="fw-medium">@TaxAmount.ToString("N0")₫</span>
            </li>
        </ul>
        <div class="d-flex justify-content-between align-items-center p-2 rounded mb-3 bg-light border">
            <span class="fw-bold text-dark"><i class="bi bi-credit-card me-2"></i> Hình thức thanh toán</span>
            <span class="fw-bold text-primary">@(NewOrder.PaymentMethod=="Cash"?"Tiền mặt":"Chuyển khoản")</span>
        </div>

        <h6 class="fw-bold mb-3 text-muted border-top pt-3">Ưu đãi áp dụng</h6>
        
        <ul class="list-group list-group-flush mb-4">
            
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                @if (!string.IsNullOrEmpty(AppliedVoucherCode))
                {
                    <span class="text-danger fw-bold">
                        <i class="bi bi-tag-fill me-1"></i> Giảm giá (@AppliedVoucherCode)
                    </span>
                    <span class="fw-bold text-danger">
                        - @DiscountAmount.ToString("N0")₫
                    </span>
                }
                else
                {
                    <span class="text-secondary">Giảm giá Voucher</span>
                    <span class="fw-medium text-muted">0₫</span>
                }
            </li>
        </ul>

        <div class="d-flex justify-content-between align-items-center pt-3 border-top border-2">
            <label class="fs-4 fw-bold">TỔNG THANH TOÁN</label>
            <label class="fs-3 fw-bolder text-danger" id="finalTotal">
                @FinalTotal.ToString("N0")₫
            </label>
        </div>
        
    </div>
</div>

@code {
    [Parameter] public Order NewOrder { get; set; }
    public decimal TotalProductPrice { get; set; }
    public int TotalItems { get; set; }

    public decimal ShippingFee { get; set; } = 0;
    public decimal TaxRate { get; set; } = 0.10M;

    public string? AppliedVoucherCode { get; set; } = "";
    public decimal DiscountAmount { get; set; }

    public decimal TaxAmount => TotalProductPrice * TaxRate;

    public decimal FinalTotal => (TotalProductPrice + ShippingFee + TaxAmount) - DiscountAmount;

    protected override void OnInitialized()
    {
        TotalProductPrice = NewOrder.OrderDetails.Sum(d=> d.SubTotal);
        TotalItems = NewOrder.OrderDetails.Count;
        AppliedVoucherCode = NewOrder.Voucher?.Code;
        DiscountAmount = NewOrder.DiscountAmount;
    }
}