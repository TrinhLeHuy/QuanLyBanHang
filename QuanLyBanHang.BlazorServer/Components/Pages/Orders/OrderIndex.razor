@page "/orders"
@inject IOrderService OrderService
@inject IProductService ProductService
@inject ICustomerService CustomerService
@inject IEmployeeService EmployeeService
@inject IVoucherService VoucherService
@inject IJSRuntime JS
@rendermode InteractiveServer

<link rel="stylesheet" href="/css/Orders.css" />
<h2 class="mb-4">Quản lý đơn hàng</h2>

<div class="d-flex align-items-center mb-4 gap-2">
    <label for="filterType" class="form-label mb-0">Lọc theo:</label>
    <select id="filterType" class="form-select w-auto">
        <option value="1">Tên khách hàng</option>
        <option value="2">Khoảng thời gian</option>
    </select>
</div>

<div class="d-flex flex-column flex-md-row align-items-start gap-3 mb-4">
    <input type="text" id="strFilterOrder" name="keyword" class="form-control w-25" placeholder="Tìm theo tên khách hàng..." />

    <div class="d-flex align-items-center gap-2 d-none" id="inputFilterDate">
        <input type="date" id="startDate" class="form-control" value="@today.AddDays(-1).ToString("yyyy-MM-dd")" />
        <span>-</span>
        <input type="date" id="endDate" class="form-control" value="@today.ToString("yyyy-MM-dd")" />
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary" id="btnFilterOrder">Tìm kiếm</button>
        <button type="button" class="btn btn-danger" id="btnRefreshOrder">Bỏ lọc</button>
    </div>
</div>


<div class="d-flex mb-3">
    <input type="text" class="form-control w-25"
           placeholder="Tìm theo tên khách hàng..."
           @bind="keyword">

    <button class="btn btn-primary ms-2" @onclick="FilterOrder">Tìm kiếm</button>
    <button class="btn btn-danger ms-2" id="@(isFiltered ? "" : "btnRefreshOrder")"  @onclick="ResetFilter">Bỏ lọc</button>
</div>

<button class="btn btn-success mb-3" @onclick="OpenCreate">Tạo đơn hàng</button>
<div style="max-height: 800px; overflow-y: auto;">
    <table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>Mã đơn</th>
            <th>Khách hàng</th>
            <th>Ngày đặt</th>
            <th>Tổng tiền</th>
            <th>Giảm giá</th>
            <th style="width: 1%">
                <div class="d-flex align-items-center gap-2">
                    <span>Trạng thái:</span>
                    <select class="form-select w-auto" id="filterStatus">
                        <option>Tất cả</option>
                        @foreach (OrderStatus s in Enum.GetValues(typeof(OrderStatus)))
                        {
                            <option value="@s">@s</option>
                        }
                    </select>
                </div>
            </th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody>
        <OrderTable Orders="orders" OnView="OpenDetail" />
    </tbody>
</table>
</div>

<DialogContainer IsOpen="@showDialog" IsOpenChanged="OnDialogChanged">
    @currentDialog
</DialogContainer>

@code {
    private List<Order> orders = new();
    private List<Product> products = new();
    private List<Customer> customers = new();
    private List<Employee> employees = new();
    private List<Voucher> vouchers = new();
    string keyword = "";
    bool showDialog;
    bool isFiltered = false;
    private DateTime today = DateTime.Now;
    RenderFragment? currentDialog;

    protected override async Task OnInitializedAsync()
    {
        orders = await OrderService.GetAllAsync();
    }

    async Task FilterOrder()
    {
        orders = await OrderService.GetByFilterNameAsync(keyword);
        isFiltered = true;
    }

    async Task<Order?> OrderById(int id)
    {
        return await OrderService.GetByIdAsync(id);
    }

    async Task ResetFilter()
    {
        keyword = "";
        orders = await OrderService.GetAllAsync();
        isFiltered = false;
    }

    async Task GetAllProduct()
    {
        products = await ProductService.GetAllProductAsync();
    }

    async Task GetAllResCreate()
    {
        products = await ProductService.GetAllProductAsync();
        customers = await CustomerService.GetAllAsync();
        employees = await EmployeeService.GetAllAsync();
        vouchers = await VoucherService.GetAllAsync();
    }

    async Task OpenCreate()
    {
        await GetAllResCreate();

        ShowOrderCreate(products, employees, customers, vouchers);
    }

    void ShowOrderCreate(List<Product> products, List<Employee> employees, List<Customer> customers, List<Voucher> vouchers)
    {
        currentDialog = builder =>
        {
            builder.OpenComponent(0, typeof(OrderCreate));
            builder.AddAttribute(1, "OnCreate", EventCallback.Factory.Create<Order>(this, OnCreate));
            builder.AddAttribute(2, "products", products);
            builder.AddAttribute(3, "employees", employees);
            builder.AddAttribute(4, "customers", customers);
            builder.AddAttribute(5, "vouchers", vouchers);
            builder.AddAttribute(6, "ShowErrorValue", EventCallback.Factory.Create<string>(this, ShowErrorValue));
            // builder.AddAttribute(6, "OnClose", EventCallback.Factory.Create(this, Close));
            builder.CloseComponent();
        };
        showDialog = true;
    }

    async Task OpenDetail(int id)
    {
        var order = await OrderById(id);
        await GetAllProduct();

        ShowOrderDetail(order, products);
    }

    void ShowOrderDetail(Order order, List<Product> products)
    {
        currentDialog = builder =>
        {
            builder.OpenComponent(0, typeof(OrderDetail));
            builder.AddAttribute(1, "order", order);
            builder.AddAttribute(2, "Products", products);
            builder.AddAttribute(3, "OnUpdate", EventCallback.Factory.Create<Order>(this, OnUpdate));
            // builder.AddAttribute(4, "OnClose", EventCallback.Factory.Create(this, Close));
            builder.CloseComponent();
        };

        showDialog = true;
        StateHasChanged();
    }




    void Close()
    {
        showDialog = false;
        StateHasChanged();
    }

    async Task OnCreate(Order order)
    {
        try
        {
            await OrderService.CreateAsync(order);
            await ShowSuccessCreate();
            showDialog = false;
            await ReloadTable();
        }catch(Exception ex)
        {
            await ShowError();
        }

    }

    async Task OnUpdate(Order order)
    {
        try 
        {
            await OrderService.UpdateAsync(order);
            await ShowSuccessUpdate();
            showDialog = false;
            await ReloadTable();
        }
        catch (Exception ex)
        {
            await ShowError();
        }

    }

    async Task ReloadTable()
    {
        orders = await OrderService.GetAllAsync();
    }

    Task OnDialogChanged(bool v)
    {
        showDialog = v;
        return Task.CompletedTask;
    }
    private async Task ShowSuccessCreate()
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowSuccess", "Đã tạo đơn hàng!");
    }

    private async Task ShowSuccessUpdate()
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowSuccess", "Đã cập nhật trạng thái đơn hàng!");
    }

    private async Task ShowError()
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowError", "Có lỗi xảy ra!");
    }

    private async Task ShowErrorValue(string error)
    {
        await JS.InvokeVoidAsync("SwalInterop.ShowError", error);
    }

    private async Task ShowConfirm()
    {
        bool confirmed = await JS.InvokeAsync<bool>("SwalInterop.ShowConfirm", "Bạn muốn xóa mục này?");
        if (confirmed)
        {
            Console.WriteLine("Đã xác nhận");
        }
        else
        {
            Console.WriteLine("Đã hủy");
        }
    }
}

